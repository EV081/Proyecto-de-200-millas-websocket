service: pedidos-workflow
frameworkVersion: "4"
org: darosv

provider:
  name: aws
  runtime: python3.12
  region: us-east-1
  stage: dev
  timeout: 20
  memorySize: 256
  iam:
    role: arn:aws:iam::645337731455:role/LabRole
  httpApi:
    cors: true
  environment:
    EVENT_SOURCE: 200millas.delivery
    EVENT_BUS: default

functions:
  # === API Delivery: una Lambda por estado ===
  CocinaAsignada:
    handler: src/cocina_asignada.lambda_handler
    events:
      - httpApi:
          method: POST
          path: /delivery/cocina-asignada

  CocinaCompleta:
    handler: src/cocina_completa.lambda_handler
    events:
      - httpApi:
          method: POST
          path: /delivery/cocina-completa

  EmpaquetadoCompleto:
    handler: src/empaquetado_completo.lambda_handler
    events:
      - httpApi:
          method: POST
          path: /delivery/empaquetado-completo

  EntregaDelivery:
    handler: src/entrega_delivery.lambda_handler
    events:
      - httpApi:
          method: POST
          path: /delivery/entrega-delivery

  # === Lambda que recibir√° el evento (ACK) ===
  AckStatus:
    handler: src/ack_status.lambda_handler

resources:
  Resources:

    # --- Regla EventBridge: escucha SOLO tus 4 estados ---
    OrderStatusRule:
      Type: AWS::Events::Rule
      Properties:
        Name: !Sub "${AWS::StackName}-OrderStatusRule"
        EventBusName: default
        EventPattern:
          source: [ "200millas.delivery" ]
          detail-type:
            - COCINA_ASIGNADA
            - COCINA_COMPLETA
            - EMPAQUETADO_COMPLETO
            - ENTREGA_DELIVERY
        Targets:
          - Id: AckLambda
            Arn: !GetAtt AckStatusLambdaFunction.Arn

    # --- Permiso para que EventBridge pueda invocar la Lambda ---
    EventInvokePermission:
      Type: AWS::Lambda::Permission
      Properties:
        FunctionName: !Ref AckStatusLambdaFunction
        Action: lambda:InvokeFunction
        Principal: events.amazonaws.com
        SourceArn: !GetAtt OrderStatusRule.Arn

custom:
  pythonRequirements:
    slim: true
